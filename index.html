<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>DQ7 ÊîªÁï•</title>
    <style>
        body { min-height: 100vh; background: #ffffff; padding: 15px; color: #1e293b; font-family: sans-serif; margin: 0; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 450px; margin: 0 auto; }
        .app-title { text-align: center; font-size: 24px; font-weight: 900; color: #1e293b; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .guide-text { text-align: center; color: #64748b; font-size: 13px; margin-bottom: 10px; background: #f1f5f9; padding: 5px; border-radius: 8px; border: 1px solid #e2e8f0; min-height: 1.5em; }
        .grid-container { display: grid; gap: 8px; margin-bottom: 20px; }
        .card { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-weight: 900; border-radius: 12px; cursor: pointer; border: 2px solid #cbd5e1; background: #ffffff; color: #1e293b; user-select: none; transition: transform 0.1s; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .c-star { background: #fbbf24; border-color: #f59e0b; }
        .c-jk { background: #1e1b4b; border-color: #ef4444; color: white !important; }
        .c-m { background: #e2e8f0 !important; border-color: #94a3b8 !important; color: #475569 !important; }
        .text-metal { font-size: 14px !important; letter-spacing: -0.5px; }
        .c-A { background: #ef4444; border-color: #fca5a5; color: white; } 
        .c-B { background: #22c55e; border-color: #86efac; color: white; } 
        .c-C { background: #eab308; border-color: #fde047; color: white; } 
        .c-D { background: #a855f7; border-color: #d8b4fe; color: white; } 
        .c-E { background: #ec4899; border-color: #f9a8d4; color: white; } 
        .c-F { background: #06b6d4; border-color: #67e8f9; color: white; } 
        .c-G { background: #f97316; border-color: #fdba74; color: white; } 
        .c-H { background: #64748b; border-color: #cbd5e1; color: white; } 
        .c-I { background: #10b981; border-color: #6ee7b7; color: white; } 
        .c-J { background: #3b82f6; border-color: #93c5fd; color: white; } 
        .c-K { background: #fb7185; border-color: #fda4af; color: white; } 
        .card-selected { border: 4px solid #3b82f6 !important; transform: scale(1.05); z-index: 10; }
        .size-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .size-btn { padding: 10px 2px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; color: #64748b; cursor: pointer; display: flex; flex-direction: column; align-items: center; -webkit-appearance: none; }
        .size-btn-label { font-size: 15px; font-weight: 800; }
        .size-btn-sub { font-size: 11px; }
        .size-btn-active { background: #3b82f6; border-color: #2563eb; color: white; }
        .status-bar { text-align: center; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 10px; color: #1e293b; font-weight: bold; border: 1px solid #e2e8f0; }
        .swap-active { background: #fef9c3 !important; color: #854d0e !important; border-color: #facc15 !important; }
        .reset-btn { width: 100%; padding: 15px; margin-top: 25px; border-radius: 12px; background: #fee2e2; color: #b91c1c; border: 2px solid #fca5a5; font-size: 18px; font-weight: 900; cursor: pointer; -webkit-appearance: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-title">DQ7 ÊîªÁï•</div>
        <div id="size-selector" class="size-selector"></div>
        <div id="guide" class="guide-text"></div>
        <div id="status" class="status-bar"></div>
        <div id="grid" class="grid-container"></div>
        <button id="swap-mode-btn" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; background: #f1f5f9; color: #475569; font-weight: bold; cursor: pointer; margin-bottom: 10px; -webkit-appearance: none;">„Ç´„Éº„Éâ„ÅÆ‰ΩçÁΩÆ„ÇíÂÖ•„ÇåÊõø„Åà„Çã</button>
        <button id="reset-btn" class="reset-btn">Áõ§Èù¢„Çí„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà</button>
    </div>
    <script>
        const alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K'];
        const sizes = [
            { t: 12, c: 4, l: 'ÁîòÂè£', s: '(4x3)' },
            { t: 16, c: 4, l: '‰∏≠Ëæõ', s: '(4x4)' },
            { t: 20, c: 5, l: 'ËæõÂè£', s: '(5x4)' },
            { t: 24, c: 6, l: 'ÊøÄËæõ', s: '(6x4)' }
        ];

        let state = { gridSize: sizes[0], cards: Array(12).fill(''), currentTool: '‚≠ê', tapCount: 0, isSwapMode: false, selectedIdx: null };

        function save() { try { localStorage.setItem('dq7_save_v5', JSON.stringify(state)); } catch(e) {} }
        function load() {
            try {
                const saved = localStorage.getItem('dq7_save_v5');
                if (saved) { state = JSON.parse(saved); state.selectedIdx = null; }
            } catch(e) {}
        }

        function render() {
            const statusEl = document.getElementById('status');
            const guideEl = document.getElementById('guide');
            const swapBtn = document.getElementById('swap-mode-btn');
            const grid = document.getElementById('grid');

            if (state.isSwapMode) {
                guideEl.textContent = "ÂÖ•„ÇåÊõø„Åà„Åü„ÅÑ„Ç´„Éº„Éâ„Çí2ÊûöÈÅ∏Êäû";
                statusEl.textContent = '‚ú® ÂÖ•„ÇåÊõø„Åà„É¢„Éº„Éâ';
                statusEl.className = 'status-bar swap-active';
                swapBtn.textContent = 'ÂÖ•Âäõ„Å´Êàª„Çã';
            } else {
                guideEl.textContent = "„ÄåÊï∞ÂÄ§„Äç„ÅÆ‰ΩçÁΩÆ„ÇíÈ†Ü„Å´„Çø„ÉÉ„Éó";
                statusEl.textContent = `Ê¨°: ${state.currentTool} ${alphabet.includes(state.currentTool) ? `(${state.tapCount + 1}/2)` : ''}`;
                statusEl.className = 'status-bar';
                swapBtn.textContent = '‰ΩçÁΩÆ„ÇíÂÖ•„ÇåÊõø„Åà„Çã';
            }

            const sizeSelector = document.getElementById('size-selector');
            sizeSelector.innerHTML = '';
            sizes.forEach(size => {
                const btn = document.createElement('button');
                btn.className = `size-btn ${state.gridSize.t === size.t ? 'size-btn-active' : ''}`;
                btn.innerHTML = `<span class="size-btn-label">${size.l}</span><span class="size-btn-sub">${size.s}</span>`;
                btn.onclick = (e) => {
                    e.preventDefault();
                    if(confirm('„É™„Çª„ÉÉ„Éà„Åó„Å¶„Çµ„Ç§„Ç∫Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü')){
                        state.gridSize = size; state.cards = Array(size.t).fill('');
                        state.currentTool = '‚≠ê'; state.tapCount = 0; state.isSwapMode = false;
                        save(); render();
                    }
                };
                sizeSelector.appendChild(btn);
            });

            grid.style.gridTemplateColumns = `repeat(${state.gridSize.c}, 1fr)`;
            grid.innerHTML = '';
            state.cards.forEach((val, i) => {
                const card = document.createElement('div');
                let cClass = 'card';
                if (val === '‚≠ê') cClass += ' c-star';
                else if (val === 'üíÄ') cClass += ' c-jk';
                else if (val === 'METAL') cClass += ' c-m text-metal';
                else if (val !== '') cClass += ` c-${val}`;
                card.className = `${cClass} ${state.selectedIdx === i ? 'card-selected' : ''}`;
                card.style.fontSize = state.gridSize.c >= 6 ? '32px' : '40px';
                card.textContent = val;
                card.onclick = (e) => { e.preventDefault(); handleCardClick(i); };
                grid.appendChild(card);
            });
        }

        function handleCardClick(i) {
            if (state.isSwapMode) {
                if (state.selectedIdx === null) { state.selectedIdx = i; } 
                else {
                    const temp = state.cards[state.selectedIdx];
                    state.cards[state.selectedIdx] = state.cards[i];
                    state.cards[i] = temp;
                    state.selectedIdx = null;
                }
            } else {
                if (state.cards[i] === 'üíÄ') { state.cards[i] = 'METAL'; }
                else if (state.cards[i] === 'METAL') { state.cards[i] = 'üíÄ'; }
                else if (state.cards[i] === '‚≠ê') { state.cards[i] = ''; state.currentTool = '‚≠ê'; state.tapCount = 0; }
                else if (state.cards[i] === '') {
                    state.cards[i] = state.currentTool;
                    if (state.cards.filter(c => c !== '').length === state.gridSize.t) { state.isSwapMode = true; } 
                    else { updateTool(); }
                }
            }
            save(); render();
        }

        function updateTool() {
            if (state.currentTool === '‚≠ê') state.currentTool = 'üíÄ';
            else if (state.currentTool === 'üíÄ' || state.currentTool === 'METAL') { state.currentTool = 'A'; state.tapCount = 0; }
            else {
                state.tapCount++;
                if (state.tapCount >= 2) {
                    const idx = alphabet.indexOf(state.currentTool);
                    if (idx < alphabet.length - 1) { state.currentTool = alphabet[idx + 1]; state.tapCount = 0; }
                }
            }
        }

        document.getElementById('swap-mode-btn').onclick = (e) => {
            e.preventDefault();
            state.isSwapMode = !state.isSwapMode;
            state.selectedIdx = null;
            render();
        };

        document.getElementById('reset-btn').onclick = (e) => {
            e.preventDefault();
            if(confirm('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                state.cards = Array(state.gridSize.t).fill('');
                state.currentTool = '‚≠ê'; state.tapCount = 0; state.isSwapMode = false;
                save(); render();
            }
        };

        window.onload = () => { load(); render(); };
    </script>
</body>
</html>
